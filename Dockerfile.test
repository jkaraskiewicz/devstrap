FROM rust:1.82 as builder

WORKDIR /build

# Copy the project files
COPY Cargo.toml Cargo.lock ./
COPY src ./src
COPY tests ./tests

# Build the release binary
RUN cargo build --release

# Create the runtime image
FROM ubuntu:22.04

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    sudo \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create a test user
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Switch to test user
USER testuser
WORKDIR /home/testuser

# Copy the built binary from builder
COPY --from=builder --chown=testuser:testuser /build/target/release/devstrap /usr/local/bin/devstrap

# Copy test config
COPY --chown=testuser:testuser test-config.toml /home/testuser/config.toml

# Set up environment
ENV RUST_LOG=info

CMD ["/bin/bash"]
